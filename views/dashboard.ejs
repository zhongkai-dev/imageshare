<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
  <div class="container">
    <a class="navbar-brand" href="#">Image Share</a>
    <div class="ms-auto">
      <span class="badge bg-primary me-2">User ID: <%= userId %></span>
      <a href="/auth/logout" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
  </div>
</nav>

<div class="chat-container">
  <!-- Chat area -->
  <div class="chat-area" id="chatArea">
    <% if (typeof error !== 'undefined') { %>
      <div class="alert alert-danger" role="alert">
        <%= error %>
      </div>
    <% } %>
    
    <% if (groupedFiles && groupedFiles.length > 0) { %>
      <% groupedFiles.forEach(group => { %>
        <div class="message-container">
          <div class="message">
            <div class="message-header">
              <strong><%= userId %></strong>
              <small class="text-muted"><%= new Date(group.date).toLocaleString() %></small>
              <!-- Delete bubble button -->
              <form action="/files/delete-group/<%= group.groupId %>" method="POST" class="d-inline ms-2 delete-message-form">
                <button type="submit" class="btn-delete-message" title="Delete message" onclick="return confirm('Delete this entire message?')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </form>
            </div>
            <div class="message-content">
              <!-- If group contains multiple images, show them in a grid -->
              <% if (group.files.length > 1 && group.files.every(file => file.mimetype.startsWith('image/'))) { %>
                <div class="image-grid <%= group.files.length > 4 ? 'grid-many' : group.files.length > 2 ? 'grid-' + group.files.length : '' %>">
                  <% group.files.forEach(file => { %>
                    <div class="image-grid-item">
                      <img src="/files/view/<%= file._id %>" alt="<%= file.originalName %>" 
                          class="img-thumbnail chat-img" 
                          onclick="openImagePreview('/files/view/<%= file._id %>', '<%= file.originalName %>')">
                    </div>
                  <% }); %>
                </div>
                <div class="file-info mt-2">
                  <span><%= group.files.length %> images</span>
                </div>
              <!-- If single image, show normally -->
              <% } else if (group.files.length === 1 && group.files[0].mimetype.startsWith('image/')) { %>
                <div class="image-preview">
                  <img src="/files/view/<%= group.files[0]._id %>" alt="<%= group.files[0].originalName %>" 
                      class="img-thumbnail chat-img" 
                      onclick="openImagePreview('/files/view/<%= group.files[0]._id %>', '<%= group.files[0].originalName %>')">
                  <div class="file-info">
                    <span><%= group.files[0].originalName %></span>
                    <small><%= (group.files[0].size / 1024).toFixed(2) %> KB</small>
                  </div>
                </div>
              <!-- For multiple non-image files or mixed content -->
              <% } else { %>
                <div class="file-group">
                  <% group.files.forEach(file => { %>
                    <div class="file-bubble">
                      <i class="fas <%= getFileIcon(file.mimetype) %>"></i>
                      <div class="file-info">
                        <span><%= file.originalName %></span>
                        <small><%= (file.size / 1024).toFixed(2) %> KB</small>
                      </div>
                      <div class="file-actions">
                        <a href="/files/download/<%= file._id %>" class="btn btn-sm btn-primary">
                          <i class="fas fa-download"></i>
                        </a>
                        <form action="/files/delete/<%= file._id %>" method="POST" class="d-inline">
                          <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this file?')">
                            <i class="fas fa-trash-alt"></i>
                          </button>
                        </form>
                      </div>
                    </div>
                  <% }); %>
                </div>
              <% } %>
              
              <!-- Group-level actions for image groups -->
              <% if (group.files.length > 1 && group.files.every(file => file.mimetype.startsWith('image/'))) { %>
                <div class="message-actions mt-2">
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="downloadAllFiles('<%= JSON.stringify(group.files.map(f => f._id)) %>')">
                      <i class="fas fa-download"></i> Download All
                    </button>
                  </div>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <div class="empty-state">
        <i class="fas fa-cloud-upload-alt fa-4x text-muted mb-3"></i>
        <h5 class="text-muted">No files uploaded yet</h5>
        <p>Upload your first file using the options below.</p>
      </div>
    <% } %>
    
    <!-- Spacer to ensure last message isn't covered by the upload form -->
    <div style="height: 15px;"></div>
  </div>
  
  <!-- Upload form with separate options -->
  <div class="upload-form">
    <div class="upload-tabs">
      <div class="btn-group w-100 mb-2">
        <button type="button" class="btn btn-outline-primary active" id="imagesTabBtn" onclick="switchTab('images')">
          <i class="fas fa-images me-1"></i> Images
        </button>
        <button type="button" class="btn btn-outline-primary" id="filesTabBtn" onclick="switchTab('files')">
          <i class="fas fa-file me-1"></i> Files
        </button>
      </div>
    </div>
    
    <!-- Images Upload Form -->
    <div id="imagesUploadForm" class="upload-tab-content">
      <form action="/files/upload-images" method="post" enctype="multipart/form-data">
        <div class="input-group">
          <input type="file" class="form-control" name="images" multiple accept="image/*" required>
          <div class="input-group-append">
            <button type="submit" class="btn btn-primary">Upload Images</button>
          </div>
        </div>
      </form>
    </div>
    
    <!-- Files Upload Form -->
    <div id="filesUploadForm" class="upload-tab-content">
      <form action="/files/upload-documents" method="post" enctype="multipart/form-data">
        <div class="input-group">
          <input type="file" class="form-control" name="files" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar,.ppt,.pptx" required>
          <div class="input-group-append">
            <button type="submit" class="btn btn-primary">Upload Files</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Image Preview Modal -->
<div class="image-preview-overlay" id="imagePreviewOverlay" onclick="closeImagePreview()">
  <div class="image-preview-container">
    <div class="image-preview-header">
      <span id="previewImageName"></span>
      <button class="close-btn" onclick="closeImagePreview()">Ã—</button>
    </div>
    <img id="previewImage" class="preview-image" src="" alt="Preview">
  </div>
</div>

<script>
  // Scroll to bottom of chat on load
  window.onload = function() {
    const chatArea = document.getElementById('chatArea');
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // Add submit handlers to show loading indicators
    document.getElementById('imagesUploadForm').addEventListener('submit', function() {
      const btn = this.querySelector('button[type="submit"]');
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
      btn.disabled = true;
    });
    
    document.getElementById('filesUploadForm').addEventListener('submit', function() {
      const btn = this.querySelector('button[type="submit"]');
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
      btn.disabled = true;
    });
  };
  
  // Tab switching functionality
  function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.upload-tab-content').forEach(tab => {
      tab.style.display = 'none';
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.upload-tabs .btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show the selected tab content and activate button
    if (tabName === 'images') {
      document.getElementById('imagesUploadForm').style.display = 'block';
      document.getElementById('imagesTabBtn').classList.add('active');
    } else {
      document.getElementById('filesUploadForm').style.display = 'block';
      document.getElementById('filesTabBtn').classList.add('active');
    }
  }
  
  // Image preview functionality
  function openImagePreview(src, name) {
    document.getElementById('previewImage').src = src;
    document.getElementById('previewImageName').innerText = name;
    document.getElementById('imagePreviewOverlay').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    event.stopPropagation();
  }
  
  function closeImagePreview() {
    document.getElementById('imagePreviewOverlay').style.display = 'none';
    document.body.style.overflow = 'auto';
  }
  
  // Helper function for file icons
  function getFileIcon(mimetype) {
    if (mimetype.startsWith('image/')) return 'fa-file-image text-primary';
    if (mimetype === 'application/pdf') return 'fa-file-pdf text-danger';
    if (mimetype.includes('document') || mimetype.includes('word')) return 'fa-file-word text-primary';
    if (mimetype.includes('spreadsheet') || mimetype.includes('excel')) return 'fa-file-excel text-success';
    if (mimetype.includes('audio')) return 'fa-file-audio text-warning';
    if (mimetype.includes('video')) return 'fa-file-video text-danger';
    if (mimetype.includes('zip') || mimetype.includes('compressed')) return 'fa-file-archive text-warning';
    if (mimetype.includes('text/')) return 'fa-file-alt text-info';
    return 'fa-file text-secondary';
  }
  
  // Download all files in a group
  function downloadAllFiles(fileIds) {
    try {
      const ids = JSON.parse(fileIds);
      ids.forEach((id, index) => {
        // Slight delay between downloads to avoid browser blocking
        setTimeout(() => {
          window.open('/files/download/' + id, '_blank');
        }, index * 300);
      });
    } catch (e) {
      console.error('Error downloading files:', e);
    }
  }

  // Image preview functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Handle image clicks for preview
    document.querySelectorAll('.chat-img, .image-grid-item img').forEach(img => {
      img.addEventListener('click', function() {
        const overlay = document.getElementById('imagePreviewOverlay');
        const previewImage = document.getElementById('previewImage');
        const imageTitle = document.getElementById('imageTitle');
        
        previewImage.src = this.src;
        imageTitle.textContent = this.alt || 'Image Preview';
        overlay.style.display = 'flex';
      });
    });
    
    // Close preview on button click
    document.getElementById('closePreview').addEventListener('click', function() {
      document.getElementById('imagePreviewOverlay').style.display = 'none';
    });
    
    // Close preview on overlay click
    document.getElementById('imagePreviewOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        this.style.display = 'none';
      }
    });
    
    // Handle PWA install prompt for iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches;
    
    if (isIOS && !isInStandaloneMode) {
      document.getElementById('iosInstallMessage').style.display = 'block';
    }

    // Tab switching functionality
    const imagesTabBtn = document.getElementById('imagesTabBtn');
    const filesTabBtn = document.getElementById('filesTabBtn');
    const imagesUploadForm = document.getElementById('imagesUploadForm');
    const filesUploadForm = document.getElementById('filesUploadForm');

    // Initially show images form and hide files form
    imagesUploadForm.style.display = 'block';
    filesUploadForm.style.display = 'none';
    imagesTabBtn.classList.add('active');

    // Switch to images tab
    imagesTabBtn.addEventListener('click', function() {
      imagesUploadForm.style.display = 'block';
      filesUploadForm.style.display = 'none';
      imagesTabBtn.classList.add('active');
      filesTabBtn.classList.remove('active');
    });

    // Switch to files tab
    filesTabBtn.addEventListener('click', function() {
      filesUploadForm.style.display = 'block';
      imagesUploadForm.style.display = 'none';
      filesTabBtn.classList.add('active');
      imagesTabBtn.classList.remove('active');
    });
  });
</script> 